---
title: 'Report 3: Maroubra rocky shore'
author: "Brie Sherow"
date: "11/04/2021"
output: 
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
    df_print: paged
  pdf_document:
    toc: yes
---


```{r setup, warning=FALSE, message=FALSE, results='hide', include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2) #graphing
library(tidyverse) #data manipulation
# library(kableExtra) #table layouts
library(broom) #tidy tables
library(sjPlot) #tidy tables
library(sjmisc) #tidy tables
library(sjlabelled) #tidy tables
library(car) #better qqplots with confint
library(vegan) #ordination
library(emmeans) #pairwise comparisons

```

# Supplementary materials
The repository used to store this data can be found at [https://github.com/brieaspasia/BEES5041](https://github.com/brieaspasia/BEES5041)

```{r load-data}


#load abundance
abund <- read.csv(file = "data/multivariate/Maroubra_rock_pools.csv", header = T)

#remove X column
abund <- abund %>%
  dplyr::select(-X)
```

# Intro
In this study I will answer two questions: 1) Does gastropod abundance differ with species and height on the shore (regression and ANOVA), and 2) Does species composition differ in rockpool vs emergent habitats, and between sampling years.  (multivariate)

# Sampling methods
  The study location is a rocky shoreline on Maroubra Beach in Sydney, Australia. 
  
  To test the hypothesis that abundance of gastropod species changes along shore gradients, students chose sites randomly along the rocky shore. An x,y grid of quadrats was created with a tape measure in a T-shape with the long end parallel to the shore. Coordinates of the samples were chosen with a random numbers table. This process was completed separately for each of the three species sampled; Austrolittorina, Nodilittorina, and Nerita. For each quadrat, students recorded the number of snails within the target species, the distance to nearest rockpool, and the zone (low, mid, or high).
  
  To test the hypothesis that species composition differs between rockpool and emergent habitats, students designated an equal number of quadrats in each habitat. For each quadrat, students recorded whether the habitat was in a rockpool, and the number of each of the target species present.


# Analysis methods
A description of how the data were analysed foreach hypothesis.This should include any treatment of the data before analysis, what tests were run and how any assumptions of those tests were checked).(10 marks, 2-3 paragraphs)


```{r explore-data}
#load zones
gastropods <- read.csv(file = "data/Linear_models/MaroubraZones.csv", header = T)
      #remove X column
      gastropods <- gastropods %>%
        dplyr::select(-X)

#visualise differences in species
ggplot(ner, aes(Zone, Abundance)) + geom_boxplot()
      
      ggplot(gastropods, aes(Zone, Abundance)) +
        geom_boxplot() +
        facet_wrap(~Species, scales="free_y")
      
gastro_summary <- gastropods %>%
  group_by(Species, Zone) %>% 
  summarise(mean_Abundance = mean(Abundance),
  sd_Abundance = sd(Abundance),
  SE_Abundance = sd(Abundance)/sqrt(n()))

ggplot(gastro_summary, 
       aes(Zone, mean_Abundance)) +
  geom_col() +
  geom_errorbar(aes(ymin = mean_Abundance - SE_Abundance,
   ymax = mean_Abundance + SE_Abundance), 
   width=0.2) +
  facet_wrap(~Species, scales="free_y")
```



```{r gast-anova}
#contrast abundance across zones
gast.anova <- aov(Abundance ~ Zone * Species, data = gastropods)

#check assumptions: 
    #the data is highly skewed to the left, so transformations are necessary
    hist(gast.anova$residuals)
  
    # #creating transformations from sqrt, log10, and 1/8 rt
    # gastropods <- mutate(gastropods, sqrt_abund = sqrt(Abundance+1))
    # gastropods <- mutate(gastropods, rt_abund = (Abundance+1)^(1/8))
    gastropods <- mutate(gastropods, log_abund = log10(Abundance+1))
  
    # #creating anovas to test with each transformation
    # SQgast.anova <- aov(sqrt_abund ~ Zone * Species, data = gastropods)
    # RTgast.anova <- aov(rt_abund ~ Zone * Species, data = gastropods)
    LGgast.anova <- aov(log_abund ~ Zone * Species, data = gastropods)
    
    # #checking the distribution with each transformation
    # hist(SQgast.anova$residuals)
    # hist(RTgast.anova$residuals)
    hist(LGgast.anova$residuals)
    
    # #checking the QQ plot with confidence intervals
    # # par(mfrow=c(2,2))
    # qqPlot(SQgast.anova$residuals)
    # qqPlot(RTgast.anova$residuals)
    qqPlot(LGgast.anova$residuals)

  # #looking at the residuals vs fits graph
  #   plot(SQgast.anova)
  #   plot(RTgast.anova)
    plot(LGgast.anova)

#This data is likely better suited to a GLM model, but within the parameters of this class, I've chosen a log transformation as the best fit.

    #summary table
    summary(LGgast.anova)
    
    #Both species and zone are significant, and there is an interaction between.

    #tukey test
    TukeyHSD(LGgast.anova)

```

```{r emmeans}
comp1 <- emmeans(LGgast.anova, ~Species|Zone)
pairs(comp1)

comp2 <- emmeans(LGgast.anova, ~Zone|Species)
pairs(comp2)
```

#we care about things within species, differences between the three, and we want to look at the differences between shore heights.  Look at it within species and within tide heights.


```{r maroubra-rockpools}
#load data
RockPools <- read.csv(file = "data/multivariate/Maroubra_rock_pools.csv", header = TRUE)

#create abundance matrix
RockPools_vars <- dplyr::select(RockPools, -X, -Habitat, - Year, -Replicate)

#Some of the variables are % cover (the red, brown and green algae) and some are counts of individual animals. Clearly 100% cover is not equivalent to 100 snails, so we can standardise these variables to ensure each variable is on the same scale. We can use the function decostand from vegan to standardise each variable by the maximum value of that variable. We then end up with all variables having values between 0 and 1.
com <- decostand(RockPools_vars, method= "max")

#create MDS with Bray-Curtis for species composition community data
rockpools.mds <- metaMDS(com, distance = "bray", autotransform = FALSE, trace=FALSE)

data.scores <- data.frame(rockpools.mds$points)

data.scores$habitat <- RockPools$Habitat

data.scores$year <- as.factor(RockPools$Year)

ggplot(data.scores, aes(MDS1, MDS2, color = habitat, shape=year)) + geom_point(alpha=0.8)
```


```{r adonis-pairwise, warning=FALSE, message=FALSE}
#Both land use and covid have significant scores, but there is not a significant interaction between them
df.adonis <- adonis(com ~ data.scores$habitat*data.scores$year, permutations=999, method="bray")
df.adonis
#testing land use dispersion
df.dis <- vegdist(com, method = "bray") # make a distance matrix
df.betadisper.hab <- betadisper(df.dis, data.scores$habitat) # test dispersion
df.betadisper.hab
permutest(df.betadisper.hab) #dispersion not significant
#testing covid dispersion
df.dis <- vegdist(com, method = "bray") # make a distance matrix
df.betadisper.yr <- betadisper(df.dis, data.scores$year) # test dispersion
df.betadisper.yr
permutest(df.betadisper.yr) #dispersion not significant

# #pairwise land use comparisons -- differences in CBD vs Industrial and Transport vs Industrial
# LUZ.pair <- pairwise.adonis(df.dis, abund$LUZ, sim.method="bray", perm = 999, sim.function = "vegdist")
# LUZ.pair
# #pairwise land use comparisons -- differences between all pairs
# cov.pair <- pairwise.adonis(df.dis, abund$covid, sim.method="bray", perm = 999, sim.function = "vegdist")
# cov.pair
```

# Results

A written description of your findings (10 marks, 3-4 paragraphs)

Figures that visualise those results (with figure legend) (15 marks)

The details of statistical tests that support the conclusions you made in the text (either incorporated into the text, or in a table with an appropriate table legend). (10 marks)

# References
